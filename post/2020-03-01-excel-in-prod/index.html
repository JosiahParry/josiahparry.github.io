<!DOCTYPE html>

<html lang="en-us">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>Josiah Parry</title>
    
    
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="/css/main.min.a62406a6581a81752707b1c450d32cb4f14471fda346c7dffeda0a7df0ec8886.css"/>

    
    
    

    
    
 
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WZD2QXY3QW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-WZD2QXY3QW');
</script>
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="/">Josiah Parry</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="/about/">about</a>
  
    <a class="color-link nav-link" href="/">posts</a>
  
    <a class="color-link nav-link" href="/projects/">projects</a>
  
    <a class="color-link nav-link" href="/tags/">tags</a>
  
    <a class="color-link nav-link" href="/archives/">archives</a>
  
  <a class="color-link nav-link" href="/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    
    <a class="social-icon" href="https://twitter.com/@josiahparry" target="_blank" rel="noopener" title="Twitter">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <path d="M8.991284,24.971612 C19.180436,24.971612 24.752372,16.530224 24.752372,9.210524 C24.752372,8.970656 24.747512,8.731868 24.736496,8.494376 C25.818008,7.712564 26.758256,6.737 27.5,5.62622 C26.507372,6.067076 25.439252,6.364292 24.318752,6.498212 C25.462472,5.812628 26.340512,4.727444 26.754584,3.434036 C25.684088,4.068536 24.499004,4.53002 23.23724,4.778528 C22.226468,3.701876 20.786828,3.028388 19.193828,3.028388 C16.134404,3.028388 13.653536,5.509256 13.653536,8.567492 C13.653536,9.0023 13.702244,9.424904 13.797176,9.830552 C9.19346,9.599108 5.11106,7.39472 2.3792,4.04294 C1.903028,4.861364 1.629032,5.812628 1.629032,6.827072 C1.629032,8.74904 2.606972,10.445612 4.094024,11.438132 C3.185528,11.41016 2.331788,11.160464 1.585184,10.745096 C1.583888,10.768208 1.583888,10.791428 1.583888,10.815728 C1.583888,13.49888 3.493652,15.738584 6.028088,16.246508 C5.562932,16.373084 5.07326,16.44134 4.56782,16.44134 C4.210988,16.44134 3.863876,16.406024 3.526484,16.34144 C4.231724,18.542264 6.276596,20.143796 8.701412,20.18894 C6.805148,21.674696 4.416836,22.56008 1.821488,22.56008 C1.374476,22.56008 0.93362,22.534592 0.5,22.4834 C2.951708,24.054476 5.862524,24.971612 8.991284,24.971612"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    
    <a class="social-icon" href="https://linkedin.com/in/josiahparry" target="_blank" rel="noopener" title="LinkedIn">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <path d="M2,3.654102 C2,2.69908141 2.79442509,1.92397846 3.77383592,1.92397846 L24.2261641,1.92397846 C25.2058917,1.92397846 26,2.69908141 26,3.654102 L26,24.3462148 C26,25.3015521 25.2058917,26.0760215 24.2261641,26.0760215 L3.77383592,26.0760215 C2.79442509,26.0760215 2,25.3015521 2,24.3465315 L2,3.65378524 L2,3.654102 Z M9.27526132,22.1415901 L9.27526132,11.2356668 L5.65030092,11.2356668 L5.65030092,22.1415901 L9.27557808,22.1415901 L9.27526132,22.1415901 Z M7.46341463,9.74691162 C8.72727273,9.74691162 9.51409566,8.90940767 9.51409566,7.86284447 C9.49033893,6.79252455 8.72727273,5.97846056 7.48748812,5.97846056 C6.24675325,5.97846056 5.43649034,6.79252455 5.43649034,7.86284447 C5.43649034,8.90940767 6.22299652,9.74691162 7.4396579,9.74691162 L7.46309788,9.74691162 L7.46341463,9.74691162 Z M11.2815965,22.1415901 L14.9062401,22.1415901 L14.9062401,16.0519481 C14.9062401,15.7263225 14.9299968,15.4000634 15.0256573,15.1675641 C15.2876148,14.5159962 15.8840672,13.8416218 16.8856509,13.8416218 C18.1970225,13.8416218 18.7218879,14.8416218 18.7218879,16.3078872 L18.7218879,22.1415901 L22.3465315,22.1415901 L22.3465315,15.8885017 C22.3465315,12.5388027 20.5584416,10.9800443 18.1735825,10.9800443 C16.2182452,10.9800443 15.3595185,12.072854 14.8824834,12.8172315 L14.9065569,12.8172315 L14.9065569,11.2359835 L11.2819132,11.2359835 C11.3291099,12.2591067 11.2815965,22.1419069 11.2815965,22.1419069 L11.2815965,22.1415901 Z"></path>
        </svg>
    </a>
    

    
    <a class="social-icon" href="https://medium.com/@JosiahParry/" target="_blank" rel="noopener" title="Medium">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <path d="M2,2 L26,2 L26,26 L2,26 L2,2 Z M7.72727142,10.0265545 L7.72727142,17.1527156 C7.77112416,17.4097828 7.69008764,17.6723786 7.50898513,17.8600642 L5.81538462,19.9143852 L5.81538462,20.1852847 L10.617683,20.1852847 L10.617683,19.9143852 L8.92408245,17.8600642 C8.74165168,17.6726892 8.65559727,17.4118239 8.69074193,17.1527156 L8.69074193,10.9897526 L12.9059255,20.1852847 L13.3951878,20.1852847 L17.0157294,10.9897526 L17.0157294,18.3190884 C17.0157294,18.514738 17.0157294,18.5523628 16.8877685,18.6802876 L15.5855778,19.9444852 L15.5855778,20.2153846 L21.9083531,20.2153846 L21.9083531,19.9444852 L20.6513252,18.7103876 C20.5403599,18.6258033 20.4853154,18.4867833 20.50831,18.3491883 L20.50831,9.28158097 C20.4853154,9.14398599 20.5403599,9.00496587 20.6513252,8.92038167 L21.9384615,7.68628409 L21.9384615,7.41538462 L17.4824105,7.41538462 L14.3059685,15.3391941 L10.6929541,7.41538462 L6.01861668,7.41538462 L6.01861668,7.68628409 L7.52403936,9.49980554 C7.67182769,9.63301305 7.74730311,9.82863473 7.72727142,10.0265545 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="https://github.com/josiahparry" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    
</div>




 
	
	<script src="/js/main.min.c1aee25a817e9beb1f9c4afd9d62311227a7f5e46720e404dc1dda97281f47f2.js" integrity="sha256-wa7iWoF+m+sfnEr9nWIxEien9eRnIOQE3B3alygfR/I="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        

<h1 class="post-title">Excel in prod</h1>
    
    <time>March 1, 2020</time>
    
    <div>
        <p>
        
<script src="/rmarkdown-libs/htmlwidgets/htmlwidgets.js"></script>
<script src="/rmarkdown-libs/dagre/dagre.min.js"></script>
<script src="/rmarkdown-libs/lodash/lodash.js"></script>
<script src="/rmarkdown-libs/nomnoml/nomnoml.js"></script>
<script src="/rmarkdown-libs/nomnoml-binding/nomnoml.js"></script>


<div id="or-how-to-incorporate-excel-into-a-production-api-using-plumber-or-a-micro-excel-micro-service." class="section level2">
<h2>or <em>how to incorporate excel into a production API using plumber</em> or, <em>a micro-excel-micro-service</em>.</h2>
<p>I recently had a conversation that touched on using <a href="https://rplumber.io"><code>plumber</code></a> to automate the parsing of Excel documents for administering data science assets. This brings up some very interesting points:</p>
<ol style="list-style-type: decimal">
<li>Excel is sometimes unavoidable and we need to be okay with that.</li>
<li>How can we incorporate Excel into production?</li>
</ol>
<blockquote>
<p>Note that this is no time to 💩 on Excel. It serves very real business purposes and unfortunately not everyone can learn to program 😕. Here’s a fun one for the h8rs: almost every presidential election campaign’s data program is based on the back of Google Sheets.</p>
</blockquote>
<p>In this post I set out to explore if and how one can incorporate Excel into productionized code. Please see the <a href="https://github.com/JosiahParry/plumber-excel">GitHub repository</a> for the code used here.</p>
<p>What does it mean to productionize code—aka put it in prod<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>? There is no one definition of what this mean and each and every organization will operationalize it differently.</p>
<blockquote>
<p>An <em>operationalized definition</em>, at least in the social science perspective, is how a thing is defined so as to have a shared understanding of said thing.</p>
</blockquote>
<p>Greg Wilson has defined it as “code that <em>isn’t</em> going to make the operations team cry” <a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a> (emphasis his). This is my favorite definition because it is whimsical, sardonic, honest, and acknowledges that the code will have to leave the data science inner circle.</p>
<p>As I understand it, the current data science discourse emphasizes the use of RESTful APIs as the best, or at least the dominant, way of <em>productionizing</em> code.</p>
<p>An API is an application programming interface. When I was first learning what APIs were my uncle told me to think of them as “machines talking to other machines.” That’s not so far off!</p>
<p>A RESTful API is a special kind of API that does <em><strong>re</strong>presentational <strong>s</strong>tate <strong>t</strong>ransfer</em>. Frankly, I do not know what that really means. As I understand it, REST is actually an opinionated way of architecting APIs. RESTful APIs use HTTP requests which makes them very easy to access. RESTful APIs are key in developing micro-services and micro-services are at the core of putting code in prod<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>. Within the python ecosystem Flask is one of the leading libraries for making micro-services. Within the R space a package called <code>plumber</code> is taking on that role.</p>
<p>We can envisage a hypothetical scenario in which we receive Excel files via some data collection process. Once that Excel file is received it is used to kick off some other process—e.g. report writing or data processing. Often people may create Shiny applications to provide a UI for uploading and data input. This is really great when we want to develop a user-centric interface. But what about when we want to automate the process or at least make the processing available to other tools? This is when we can turn to plumber as a way to create a micro-service to handle this.</p>
<div id="htmlwidget-1" style="width:672px;height:480px;" class="nomnoml html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"code":"\n  #fill: #FEFEFF\n  #lineWidth: 1\n  #zoom: 4\n  #direction: right\n   [<frame> Plumber API |\n   [<abstract>Recieve Excel File]-:> [<abstract>1: upload]\n   [<abstract>Recieve Excel File] -:> [2: use data]\n  ]\n","svg":false},"evals":[],"jsHooks":[]}</script>
<p>The above graphic (made with <a href="https://github.com/javierluraschi/nomnoml"><code>nomnoml</code></a>) illustrates two different ways we can approach this. First, we will receive the Excel file. From there we may want to upload the file into a shared drive, a database, or both. Alternatively, we may not want to store the data, but rather use it immediately.</p>
<p>From an API development perspective, we can imagine each process as an API <em>endpoint</em>. An endpoint is essentially a url which says where each application interaction will happen. In this small example, we will create two endpoints: <code>/read_excel</code> and <code>/upload</code>. The first will, you guessed it, read an Excel file that is sent with a request. The second will upload said file.</p>
<p>Before we can approach creating the API, we need to first figure out how we can even send a file through an API. And before we can figure that out, we need to know what type of requests we can make to an API. Since the REST API will be an HTTP API, its imperative we know what type of requests we can make with an HTTP protocol. There are 7 HTTP request types.</p>
<ul>
<li>GET</li>
<li>POST</li>
<li>PUT</li>
<li>HEAD</li>
<li>DELETE</li>
<li>PATCH</li>
<li>OPTION</li>
</ul>
<p>Frankly, I do not remember what <code>HEAD</code>, <code>PATCH</code>, and <code>OPTIONS</code> do—if you don’t use it you lose it, right? For super simple APIs all we need to know are <code>GET</code> and <code>POST</code> requests—catch me never <code>DELETE</code>ing anything, I can’t be trusted.</p>
<p><code>GET</code> is used to <em>get</em> data from a resource. You can pass key value pairs as parameters into the <code>GET</code> request. “<code>GET</code> requests are only used to request data (not modify).”<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a> You should never, ever, ever, ever, ever, <strong>ever</strong> send sensitive information through a <code>GET</code> request.</p>
<p>That brings us to the <code>POST</code> method. <code>POST</code> methods are used to send data to a server for the purpose of creating, modifying, or updating resources<a href="#fn5" class="footnote-ref" id="fnref5"><sup>5</sup></a>. When you have a lot of parameters to send, or if they’re sensitive, or if you need to send a file via API use <code>POST</code>.</p>
<p>In approaching this API design I had three questions.</p>
<ol style="list-style-type: decimal">
<li>How do you even send a file via HTTP request?</li>
<li>Once we send it, how do we access the file and where does it go?</li>
<li>How do we get the data from the API to R?</li>
</ol>
<p>I don’t speak Linux so bless <code>httr</code> for making this easy(ish). <code>httr</code> contains two functions that will be central to POSTing an excel file. There are <code>POST()</code> for making the POST request and <code>upload_file()</code> which will be used for uploading the file in the post request.</p>
<blockquote>
<p>Can we just take a moment to appreciate how perfectly named functions can be sometimes? The more self-explanatory the better.</p>
</blockquote>
<p>If you don’t have much experience crafting requests with <code>httr</code>, I recommend you start with the <a href="https://cran.r-project.org/web/packages/httr/vignettes/quickstart.html">quickstart vignette</a>.</p>
<p>The structure of our POST request will look like</p>
<pre class="r"><code>POST(end_point, 
     body = list(param = upload_file(&quot;file-path.ext&quot;))
     )</code></pre>
</div>
<div id="building-the-first-endpoint" class="section level2">
<h2>Building the first endpoint</h2>
<p>Now we get <em>how</em> the file will be sent. But the tough part is actually building the plumber API endpoint which will receive it. There is a fair amount of discourse on how files should be uploaded via plumber<a href="#fn6" class="footnote-ref" id="fnref6"><sup>6</sup></a>. Fortunately, <a href="https://github.com/krlmlr">@krlmlr</a> pointed out <code>mime::parse_multipart()</code> which can be used for handling files sent in requests<a href="#fn7" class="footnote-ref" id="fnref7"><sup>7</sup></a>.</p>
<blockquote>
<p>Note: MIME is a standard way of sending files through the internet. I know nothing about MIME types and greatly appreciate the work that Yihui Xie, Jeffrey Horner, and Bian Beilei have done with the <a href="https://github.com/yihui/mime"><code>{mime}</code></a> package for abstracting all of this away.</p>
</blockquote>
<p><code>parse_multipart()</code> will take the incoming request and return a named list. Most importantly for us the returned object contains our POSTed file to a temporary location. Within the resultant list is a path to to the temporary file. In our plumber function definition, we parse the request, and pull out the <code>datapath</code>. That saved path is then fed to <code>readxl::read_excel()</code> which returns a tibble!</p>
<pre class="r"><code>#* Read excel file 
#* @post /read_excel

function(req) {
  
  multipart &lt;- mime::parse_multipart(req)
  
  fp &lt;- purrr::pluck(multipart, 1, &quot;datapath&quot;, 1)
  
  readxl::read_excel(fp)
  
}</code></pre>
<div id="a-note-on-developing-plumber-apis" class="section level3">
<h3>A note on developing plumber APIs</h3>
<p>Unfortunately it’s not easy to illustrate the development of a plumber API in blog format. My secret for developing plumber APIs is a combination of the RStudio background jobs launcher and the <code>rstudioapi</code> package. To figure out the structure of the named list returned from <code>parse_multipart()</code> I returned the <code>multipart</code> object from the API.</p>
<p>In the session I was using to develop the API I had 3 scripts. The first, <code>plumber.R</code> contains the plumber endpoint definitions. The second, <code>activate.R</code> contains the following two lines of code:</p>
<pre class="r"><code>pr &lt;- plumber::plumb(&quot;plumber.R&quot;)
pr$run(host = &quot;127.0.0.1&quot;, port = 5846)</code></pre>
<p>These two lines start the API defined in <code>plumber.R</code>. In my third script, where I was developing from, I had the following function call:</p>
<pre class="r"><code># start a background job using the RStudio job launcher
rstudioapi::jobRunScript(path = file.path(here::here(), &quot;activate.R&quot;),
                         workingDir = here::here())</code></pre>
<p>This function call sources the <code>activate.R</code> in a background session. Having the API running in another session frees up the current session I work from to develop sample POST requests.This provides a rather fast paced iterative way of testing endpoint function definitions.</p>
<p><img src="https://media.giphy.com/media/cbkBcxRLwjoys/giphy.gif" /></p>
<p><sub> I hope you’re able to understand all that use of the word <em>session</em></sub></p>
<p>For example, to figure out where <code>datapath</code> was, my API definition was strictly</p>
<pre class="r"><code>#* Read excel file 
#* @post /read_excel

function(req) {
  mime::parse_multipart(req)
}</code></pre>
<p>allowing me to work with the resultant object from an active R session.</p>
</div>
</div>
<div id="uploading-files" class="section level2">
<h2>Uploading files</h2>
<p><strong>Disclaimer</strong>: Uploading files is inherently risky business. Every time you put a new file into your system you are creating an opportunity for vulnerabilities. I am not a security expert nor an API expert so take me with a grain of salt.</p>
<p>Defining an upload process is rather straight forward now that we are able to access the temporary file. We will use <code>fs::file_copy()</code> to copy the temporary file to a permanent location. To do this, we need to determine where it will be uploaded. For the sake of example I am hard coding the upload path to be at <code>./data</code>. You could feasibly create another parameter which determines where the file will be copied to, but I didn’t 🤷🏻‍♂️.</p>
<pre class="r"><code>#* Upload excel file
#* @post /upload
function(req) {
  
  multipart &lt;- mime::parse_multipart(req)
  
  fp &lt;- purrr::pluck(multipart, 1, &quot;datapath&quot;, 1)
  
  f_name &lt;- purrr::pluck(multipart, 1, &quot;name&quot;)
  
  u_path &lt;- file.path(&quot;data&quot;, f_name)
  
  fs::file_copy(fp, u_path)
  
}</code></pre>
</div>
<div id="creating-api-wrappers" class="section level2">
<h2>Creating API wrappers</h2>
<p>Creating API wrappers is one of my favorite activities because it’s rather simple and feels super empowering 💪🏼. As mentioned earlier, all we will need to do to create the POST request is to specify where to make the request (the endpoint), and provide some parameters to it.</p>
<p>Spin up the API in the background.</p>
<pre class="r"><code># start a background job using the RStudio job launcher
rstudioapi::jobRunScript(path = file.path(here::here(), &quot;activate.R&quot;),
                         workingDir = here::here())</code></pre>
<p>We first define an object called <code>b_url</code> (base url) with our endpoint. Next we specify the path of the file we want to upload within the <code>upload_file()</code> command. In the repository I’ve included <code>test.xls</code> which contains information about top coded variables in the American Community Survey (social science, amirite?). Note that uploaded file is part of a named list within the <code>body</code> argument. Any parameters that need to be passed to your API need to be defined in the list provided to the <code>body</code>. I <em>think</em> the name of the uploaded file needs to match that of what is defined in the plumber API (<code>req</code>). I may be wrong, but for safe measures!</p>
<pre class="r"><code>library(httr)
library(tidyverse)

# define the url
b_url &lt;- &quot;http://127.0.0.1:5846/read_excel&quot;

# make the request!
req &lt;- POST(b_url, body = list(req = upload_file(&quot;data/test.xls&quot;)))</code></pre>
<p>We have now uploaded the file and made our request! Though the request is useless to us if we can’t access the data 😮. We can get the content of the request using <code>httr::content()</code>. I set <code>type = &quot;text/json&quot;</code> because I find it easier to make json into a tibble than a named list.</p>
<pre class="r"><code># get json
res_json &lt;- content(req, type = &quot;text/json&quot;)

# show the first 50 characters of resultant json
strtrim(res_json, 50)</code></pre>
<pre><code>## [1] &quot;[{\&quot;statefip\&quot;:1,\&quot;costelec\&quot;:7440,\&quot;costgas\&quot;:5760,\&quot;cos&quot;</code></pre>
<p>To get this json into a tibble will use <code>jsonlite::fromJSON()</code> and <code>tibble::as_tibble()</code>.</p>
<pre class="r"><code>res &lt;- content(req, type = &quot;text/json&quot;) %&gt;% 
  jsonlite::fromJSON() %&gt;% 
  as_tibble() 

glimpse(res)</code></pre>
<pre><code>## Observations: 52
## Variables: 27
## $ statefip     &lt;int&gt; 1, 2, 4, 5, 6, 8, 9, 10, 11, 12, 13, 15, 16, 17, 18…
## $ costelec     &lt;int&gt; 7440, 7080, 7320, 6600, 7800, 6240, 7800, 6720, 648…
## $ costgas      &lt;int&gt; 5760, 6240, 4800, 5880, 5400, 5520, 6840, 6360, 528…
## $ costwatr     &lt;int&gt; 3100, 3400, 3800, 3100, 4100, 3300, 3100, 2800, 360…
## $ costfuel     &lt;int&gt; 3900, 7100, 2800, 3300, 2900, 2400, 5700, 3500, 430…
## $ condofee     &lt;int&gt; 1100, 690, 1000, 870, 1200, 920, 940, 950, 1400, 14…
## $ rent         &lt;int&gt; 2400, 2800, 2900, 2000, 3900, 3200, 3300, 2800, 390…
## $ proptx99     &lt;int&gt; 66, 69, 69, 67, 69, 69, 69, 69, 69, 69, 69, 69, 69,…
## $ propinsr     &lt;int&gt; 5400, 7500, 5000, 5200, 8100, 7200, 9800, 6000, 770…
## $ mortamt1     &lt;int&gt; 3400, 4000, 5000, 3600, 7300, 5400, 7400, 4000, 700…
## $ mortamt2     &lt;int&gt; 1600, 2900, 2400, 2200, 3900, 3600, 2900, 2700, 540…
## $ moblhome     &lt;int&gt; 4300, 7900, 10300, 4800, 13900, 12000, 8000, 10100,…
## $ rooms        &lt;int&gt; 16, 16, 15, 15, 14, 17, 17, 16, 16, 14, 18, 14, 17,…
## $ bedrooms     &lt;int&gt; 8, 8, 6, 6, 7, 7, 7, 7, 7, 6, 7, 7, 7, 7, 8, 8, 7, …
## $ valueh       &lt;int&gt; 1551000, 1945000, 2387000, 1901000, 6288000, 348100…
## $ incwage      &lt;int&gt; 391000, 439000, 412000, 422000, 565000, 498000, 718…
## $ incbus00     &lt;int&gt; 335000, 256000, 280000, 295000, 372000, 320000, 448…
## $ incinvst     &lt;int&gt; 299000, 96000, 306000, 263000, 353000, 290000, 3230…
## $ incretir     &lt;int&gt; 109000, 148000, 138000, 113000, 169000, 129000, 158…
## $ incother     &lt;int&gt; 64000, 33200, 73000, 67000, 78000, 76000, 79000, 72…
## $ incwelfr     &lt;int&gt; 10200, 11800, 12700, 11300, 18900, 14500, 19000, 75…
## $ incsupp      &lt;int&gt; 22700, 24000, 25800, 22700, 25400, 26200, 26600, 24…
## $ incss        &lt;int&gt; 34500, 32400, 34400, 35100, 35300, 35100, 37700, 36…
## $ age          &lt;int&gt; 93, 91, 93, 94, 94, 93, 96, 92, 94, 95, 92, 96, 94,…
## $ trantime     &lt;int&gt; 152, 162, 145, 129, 141, 157, 142, 157, 111, 150, 1…
## $ incbus00_min &lt;int&gt; -6900, -6500, -5000, -7800, -4800, -5800, -4800, -6…
## $ incincst_min &lt;int&gt; -1500, -800, -1600, -920, -2300, -1800, -1800, -140…</code></pre>
<p>Boom!!! It worked. Now time to make it a function. To make this generalizable we need to make it so that users can specify file paths for <code>upload_file()</code>.</p>
<pre class="r"><code># define `post_excel()`
post_excel &lt;- function(file) {

  b_url &lt;- &quot;http://127.0.0.1:5846/read_excel&quot;
  
  req &lt;- POST(b_url, body = list(req = upload_file(file)))
  
  res &lt;- content(req, type = &quot;text/json&quot;) %&gt;% 
    jsonlite::fromJSON() %&gt;% 
    tibble::as_tibble()
  
  res
  
}</code></pre>
<p>You’ve created a wrapper to your API! Now you have a micro-service running and accessible via an R wrapper.</p>
<pre class="r"><code>post_excel(&quot;data/test.xls&quot;)</code></pre>
<pre><code>## # A tibble: 52 x 27
##    statefip costelec costgas costwatr costfuel condofee  rent proptx99
##       &lt;int&gt;    &lt;int&gt;   &lt;int&gt;    &lt;int&gt;    &lt;int&gt;    &lt;int&gt; &lt;int&gt;    &lt;int&gt;
##  1        1     7440    5760     3100     3900     1100  2400       66
##  2        2     7080    6240     3400     7100      690  2800       69
##  3        4     7320    4800     3800     2800     1000  2900       69
##  4        5     6600    5880     3100     3300      870  2000       67
##  5        6     7800    5400     4100     2900     1200  3900       69
##  6        8     6240    5520     3300     2400      920  3200       69
##  7        9     7800    6840     3100     5700      940  3300       69
##  8       10     6720    6360     2800     3500      950  2800       69
##  9       11     6480    5280     3600     4300     1400  3900       69
## 10       12     6720    3480     3400     3600     1400  3300       69
## # … with 42 more rows, and 19 more variables: propinsr &lt;int&gt;,
## #   mortamt1 &lt;int&gt;, mortamt2 &lt;int&gt;, moblhome &lt;int&gt;, rooms &lt;int&gt;,
## #   bedrooms &lt;int&gt;, valueh &lt;int&gt;, incwage &lt;int&gt;, incbus00 &lt;int&gt;,
## #   incinvst &lt;int&gt;, incretir &lt;int&gt;, incother &lt;int&gt;, incwelfr &lt;int&gt;,
## #   incsupp &lt;int&gt;, incss &lt;int&gt;, age &lt;int&gt;, trantime &lt;int&gt;,
## #   incbus00_min &lt;int&gt;, incincst_min &lt;int&gt;</code></pre>
<p>We can create a similar function for the <code>/upload</code> endpoint.</p>
<pre class="r"><code>upload &lt;- function(file) {
  b_url &lt;- &quot;http://127.0.0.1:5846/upload&quot;
  
  usethis::ui_info(glue::glue(&quot;Copying {file} to /data/{file}&quot;))
  
  req &lt;- POST(b_url, body = list(req = upload_file(file)))
  
  invisible(req)
}</code></pre>
<pre class="r"><code>upload(&quot;data/test.xls&quot;)</code></pre>
<pre><code>## ℹ Copying data/test.xls to /data/data/test.xls</code></pre>
<blockquote>
<p>Note: I recommend using the <code>ui_*()</code> functions from {usethis} to provide informative messages to the user.
<br> Second note: If you intend on only allowing a file to be uploaded once, as this function does, you should probably actually be using a PUT request.</p>
</blockquote>
<p>Badah-bing badah-boom. You now have the ability to create a micro-service with plumber that is able to handle Microsoft Excel files. That is no small feat! What’s next? You should create a nice little python wrapper for your newly created API. The python wrapper will be a great asset to your team and now your R based tools are accessible to anyone or anything that can make HTTP requests!!!</p>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p><a href="https://putrinprod.com/" class="uri">https://putrinprod.com/</a><a href="#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p>Please see <a href="https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1005412"><em>Ten simple rules for making research software more robust</em></a> (Taschuk, and Wilson, 2017).<a href="#fnref2" class="footnote-back">↩</a></p></li>
<li id="fn3"><p><a href="https://medium.com/@ericjwhuang/restful-api-vs-microservice-eea903ac3e73" class="uri">https://medium.com/@ericjwhuang/restful-api-vs-microservice-eea903ac3e73</a><a href="#fnref3" class="footnote-back">↩</a></p></li>
<li id="fn4"><p><a href="https://www.w3schools.com/tags/ref_httpmethods.asp" class="uri">https://www.w3schools.com/tags/ref_httpmethods.asp</a><a href="#fnref4" class="footnote-back">↩</a></p></li>
<li id="fn5"><p><a href="https://www.w3schools.com/tags/ref_httpmethods.asp" class="uri">https://www.w3schools.com/tags/ref_httpmethods.asp</a><a href="#fnref5" class="footnote-back">↩</a></p></li>
<li id="fn6"><p><a href="https://github.com/rstudio/plumber/issues/75" class="uri">https://github.com/rstudio/plumber/issues/75</a><a href="#fnref6" class="footnote-back">↩</a></p></li>
<li id="fn7"><p><a href="https://github.com/rstudio/plumber/issues/75" class="uri">https://github.com/rstudio/plumber/issues/75</a><a href="#fnref7" class="footnote-back">↩</a></p></li>
</ol>
</div>

        </p>
    </div>
    
    

    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="/tags/plumber">#plumber</a>
        
            <a class="tag" href="/tags/excel">#Excel</a>
        
            <a class="tag" href="/tags/r-in-prod">#R in prod</a>
        
            <a class="tag" href="/tags/api">#API</a>
        
            <a class="tag" href="/tags/tutorial">#tutorial</a>
        
      
    </div>
    
      
<div id="disqus_thread"></div>
<script>
(function() {
var d = document, s = d.createElement('script');
s.src = 'https://josiahparry.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


        

<link rel="stylesheet" type="text/css" href="/css/katex.min.css">
<script type="text/javascript" src="/js/katex.min.js"></script>
<script type="text/javascript" src="/js/auto-render.min.js"onload="renderMathInElement(document.body);"></script>

        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    
    <a class="social-icon" href="https://twitter.com/@josiahparry" target="_blank" rel="noopener" title="Twitter">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <path d="M8.991284,24.971612 C19.180436,24.971612 24.752372,16.530224 24.752372,9.210524 C24.752372,8.970656 24.747512,8.731868 24.736496,8.494376 C25.818008,7.712564 26.758256,6.737 27.5,5.62622 C26.507372,6.067076 25.439252,6.364292 24.318752,6.498212 C25.462472,5.812628 26.340512,4.727444 26.754584,3.434036 C25.684088,4.068536 24.499004,4.53002 23.23724,4.778528 C22.226468,3.701876 20.786828,3.028388 19.193828,3.028388 C16.134404,3.028388 13.653536,5.509256 13.653536,8.567492 C13.653536,9.0023 13.702244,9.424904 13.797176,9.830552 C9.19346,9.599108 5.11106,7.39472 2.3792,4.04294 C1.903028,4.861364 1.629032,5.812628 1.629032,6.827072 C1.629032,8.74904 2.606972,10.445612 4.094024,11.438132 C3.185528,11.41016 2.331788,11.160464 1.585184,10.745096 C1.583888,10.768208 1.583888,10.791428 1.583888,10.815728 C1.583888,13.49888 3.493652,15.738584 6.028088,16.246508 C5.562932,16.373084 5.07326,16.44134 4.56782,16.44134 C4.210988,16.44134 3.863876,16.406024 3.526484,16.34144 C4.231724,18.542264 6.276596,20.143796 8.701412,20.18894 C6.805148,21.674696 4.416836,22.56008 1.821488,22.56008 C1.374476,22.56008 0.93362,22.534592 0.5,22.4834 C2.951708,24.054476 5.862524,24.971612 8.991284,24.971612"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    
    <a class="social-icon" href="https://linkedin.com/in/josiahparry" target="_blank" rel="noopener" title="LinkedIn">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <path d="M2,3.654102 C2,2.69908141 2.79442509,1.92397846 3.77383592,1.92397846 L24.2261641,1.92397846 C25.2058917,1.92397846 26,2.69908141 26,3.654102 L26,24.3462148 C26,25.3015521 25.2058917,26.0760215 24.2261641,26.0760215 L3.77383592,26.0760215 C2.79442509,26.0760215 2,25.3015521 2,24.3465315 L2,3.65378524 L2,3.654102 Z M9.27526132,22.1415901 L9.27526132,11.2356668 L5.65030092,11.2356668 L5.65030092,22.1415901 L9.27557808,22.1415901 L9.27526132,22.1415901 Z M7.46341463,9.74691162 C8.72727273,9.74691162 9.51409566,8.90940767 9.51409566,7.86284447 C9.49033893,6.79252455 8.72727273,5.97846056 7.48748812,5.97846056 C6.24675325,5.97846056 5.43649034,6.79252455 5.43649034,7.86284447 C5.43649034,8.90940767 6.22299652,9.74691162 7.4396579,9.74691162 L7.46309788,9.74691162 L7.46341463,9.74691162 Z M11.2815965,22.1415901 L14.9062401,22.1415901 L14.9062401,16.0519481 C14.9062401,15.7263225 14.9299968,15.4000634 15.0256573,15.1675641 C15.2876148,14.5159962 15.8840672,13.8416218 16.8856509,13.8416218 C18.1970225,13.8416218 18.7218879,14.8416218 18.7218879,16.3078872 L18.7218879,22.1415901 L22.3465315,22.1415901 L22.3465315,15.8885017 C22.3465315,12.5388027 20.5584416,10.9800443 18.1735825,10.9800443 C16.2182452,10.9800443 15.3595185,12.072854 14.8824834,12.8172315 L14.9065569,12.8172315 L14.9065569,11.2359835 L11.2819132,11.2359835 C11.3291099,12.2591067 11.2815965,22.1419069 11.2815965,22.1419069 L11.2815965,22.1415901 Z"></path>
        </svg>
    </a>
    

    
    <a class="social-icon" href="https://medium.com/@JosiahParry/" target="_blank" rel="noopener" title="Medium">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <path d="M2,2 L26,2 L26,26 L2,26 L2,2 Z M7.72727142,10.0265545 L7.72727142,17.1527156 C7.77112416,17.4097828 7.69008764,17.6723786 7.50898513,17.8600642 L5.81538462,19.9143852 L5.81538462,20.1852847 L10.617683,20.1852847 L10.617683,19.9143852 L8.92408245,17.8600642 C8.74165168,17.6726892 8.65559727,17.4118239 8.69074193,17.1527156 L8.69074193,10.9897526 L12.9059255,20.1852847 L13.3951878,20.1852847 L17.0157294,10.9897526 L17.0157294,18.3190884 C17.0157294,18.514738 17.0157294,18.5523628 16.8877685,18.6802876 L15.5855778,19.9444852 L15.5855778,20.2153846 L21.9083531,20.2153846 L21.9083531,19.9444852 L20.6513252,18.7103876 C20.5403599,18.6258033 20.4853154,18.4867833 20.50831,18.3491883 L20.50831,9.28158097 C20.4853154,9.14398599 20.5403599,9.00496587 20.6513252,8.92038167 L21.9384615,7.68628409 L21.9384615,7.41538462 L17.4824105,7.41538462 L14.3059685,15.3391941 L10.6929541,7.41538462 L6.01861668,7.41538462 L6.01861668,7.68628409 L7.52403936,9.49980554 C7.67182769,9.63301305 7.74730311,9.82863473 7.72727142,10.0265545 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="https://github.com/josiahparry" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    
    

    
</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="/js/main.min.c1aee25a817e9beb1f9c4afd9d62311227a7f5e46720e404dc1dda97281f47f2.js" integrity="sha256-wa7iWoF+m+sfnEr9nWIxEien9eRnIOQE3B3alygfR/I="></script>
</footer>
    </body>
</html>